var mainApp=angular.module("mainApp",["ngRoute","ngToast","ui.bootstrap","nvd3","angularGrid"]);mainApp.config(["$routeProvider",function(a){a.when("/main",{templateUrl:"pages/main/main.html",controller:"mainController"}).when("/users",{templateUrl:"pages/user/users.html",controller:"usersController"}).when("/users/:id",{templateUrl:"pages/user/usersdetail.html",controller:"usersDetailController"}).when("/criaruser",{templateUrl:"pages/user/criaruser.html",controller:"criarUserController"}).when("/tarefas",{templateUrl:"pages/tarefas/tarefas.html",controller:"tarefasController"}).when("/recursos",{templateUrl:"pages/recursos/recursos.html",controller:"recursosController"}).when("/criarrecursos",{templateUrl:"pages/recursos/criarrecurso.html",controller:"criarRecursosController"}).when("/recursos/:id",{templateUrl:"pages/recursos/recursosdetail.html",controller:"recursosDetailController"}).when("/recursos/:id/tarefa/:tarefa",{templateUrl:"pages/tarefas/tarefasdetail.html",controller:"tarefasDetailController"}).when("/recursos/:id/novatarefa",{templateUrl:"pages/tarefas/tarefasdetail.html",controller:"tarefasDetailController"}).when("/projectos",{templateUrl:"pages/projectos/projectos.html",controller:"projectosController"}).when("/criarprojecto",{templateUrl:"pages/projectos/projectodetail.html",controller:"projectosDetailController"}).when("/projectos/:id",{templateUrl:"pages/projectos/projectodetail.html",controller:"projectosDetailController"}).when("/backlog",{templateUrl:"pages/backlog/backlog.html",controller:"backlogController"}).when("/login",{templateUrl:"pages/users/login.html"}).otherwise({redirectTo:"/main"})}]),mainApp.config(["ngToastProvider",function(a){a.configure({verticalPosition:"top",horizontalPosition:"right",maxNumber:3,timeout:2e3,dismissOnTimeout:!0})}]),mainApp.controller("navController",["$scope",function(a){a.funcao1="Utilizadores",a.funcao2="Backlog",a.funcao3="Recursos",a.funcao4="Projectos"}]),mainApp.controller("backlogController",["$scope","BacklogServices",function(a,b){var c=["Partner","AP","Senior Manager","Manager","Senior Consultant","Consultant","Analista"],d=[{headerName:"Nível",field:"nivel",width:120},{headerName:"Recurso",field:"recurso"},{headerName:"Rate",field:"rate",width:70}],e=function(c){var d=a.gridOptions.rowData[c.rowIndex];d[c.colDef.field]=c.newValue,b.updateProjecto(c.colDef.projectId,c.newValue,"201506",d.recursoid)},f=function(a,b){var d=c.indexOf(a.nivel),e=c.indexOf(b.nivel);return d-e};a.gridOptions={columnDefs:d,showToolPanel:!0,enableColResize:!0,dontUseScrolls:!1},a.gridOptions.ready=function(){b.getBacklogColumnDefs(function(b){for(var c=0;c<b.length;c++)b[c].width=120,b[c].editable=!0,b[c].newValueHandler=e,d.push(b[c]);a.gridOptions.columnDefs=d,a.gridOptions.api.onNewCols()})},b.getBacklogData("",function(b){b.sort(f),a.gridOptions.rowData=b,a.gridOptions.api.onNewRows()})}]),mainApp.controller("mainController",["$scope","$http",function(a,b){var c=[{key:"Alocado",y:0},{key:"Livre",y:0}];a.pieOptions={chart:{type:"pieChart",height:400,x:function(a){return a.key},y:function(a){return a.y},showLabels:!0,labelThreshold:.01,legend:{margin:{top:5,right:35,bottom:5,left:0},padding:{left:10,right:10}}}},a.barOptions={chart:{type:"discreteBarChart",height:400,margin:{top:20,right:20,bottom:60,left:55},x:function(a){return a.key},y:function(a){return a.y},showValues:!0,transitionDuration:500,xAxis:{axisLabel:"Projecto"},yAxis:{axisLabel:"Nº recursos",axisLabelDistance:30}}};var d=function(b,d,e,f){for(var g=0;g<b.length;g++)"Sim"===b[g].tem.tarefa?c[0].y=c[0].y+1:c[1].y=c[1].y+1;a.data=c};b.get("/recursos/recursos").success(d).error(function(a,b,c,d){});var e=function(a,b){for(var c=0;c<b.length;c++)if(b[c].key==a)return b[c];return void 0};b.get("/recursos/tarefas").success(function(b){for(var c,d=[],f=0;f<b.length;f++)c=e(b[f].projecto,d),c?c.y=c.y+1:(c={},c.key=b[f].projecto,c.y=1,d.push(c));a.data2=[{key:"Cumulative",values:d}]}).error(function(a){})}]),mainApp.controller("projectosController",["$scope","$modal","ProjectoServices",function(a,b,c){c.getAllProjectos(function(b){a.projectos=b},function(a,b,c,d){debug("Error:"),debug(a)})}]),mainApp.controller("projectosDetailController",["$scope","$routeParams","ProjectoServices","$location",function(a,b,c,d){a.estados=["Aberto","Fechado"],b.id?(a.titulo="Detalhe de projecto",c.getProjectoForId(b.id,function(b){a.projData=b,a.projData.dataInicio=new Date(a.projData.dataInicio),a.projData.dataFim=new Date(a.projData.dataFim)},function(a,b,c,d){})):(a.titulo="Criar projecto",a.projData={},a.projData.estado="Aberto"),a.estadoSelected=function(b){a.projData.estado=b},a.gravar=function(){b.id?c.updateProjecto(b.id,a.projData,function(){d.path("/projectos/")}):c.createProjecto(a.projData,function(){d.path("/projectos/")})}}]);var niveis=["Partner","AP","Senior Manager","Manager","Senior Consultant","Consultant","Analista"];mainApp.controller("recursosController",["$scope","$filter","EmployeeServices",function(a,b,c){c.getAllEmployees(function(b){a.empregados=b},function(a){}),a.sortNome=function(){a.empregados=b("orderBy")(a.empregados,"name")},a.sortNivel=function(){a.empregados=b("orderBy")(a.empregados,"nivel")}}]),mainApp.controller("recursosDetailController",["$scope","$routeParams","ngToast","$location","EmployeeServices",function(a,b,c,d,e){a.niveis=niveis,e.getEmployeeForId(b.id,function(b){a.empData=b},function(a){}),a.gravar=function(){a.modificarForm.$valid&&e.updateEmployee(b.id,a.empData,function(a){d.path("/recursos")},function(a){})},a.adicionar=function(){d.path("/recursos/"+b.id+"/novatarefa")},a.navegarTarefa=function(a){d.path("/recursos/"+b.id+"/tarefa/"+a._id)}}]),mainApp.controller("criarRecursosController",["$scope","ngToast","$location","EmployeeServices",function(a,b,c,d){a.empData={},a.empData.nivel="Escolher nível",a.niveis=niveis,a.gravar=function(){a.criarForm.$valid&&"Escolher nível"!=a.empData.nivel?d.createEmployee(a.empData,function(){c.path("/recursos")}):b.create("Escolher nível")},a.dropSelected=function(b){a.empData.nivel=b}}]),mainApp.controller("tarefasDetailController",["$scope","$routeParams","ngToast","$location","EmployeeServices","ProjectoServices",function(a,b,c,d,e,f){var g=["Aberta","Fechada"];f.getAllProjectos(function(b){var c=[];c.push("Non-chargable");for(var d=0;d<b.length;d++)c.push(b[d].codigo);a.projectos=c},function(a){}),a.estados=g,a.tarefaData={},b.tarefa?(a.titulo="Detalhe tarefa",e.getEmployeeForId(b.id,function(c){for(var d=0;d<c.tarefas.length;d++){var e=c.tarefas[d];e._id==b.tarefa&&(a.tarefaData=e,a.tarefaData.dataInicio=new Date(a.tarefaData.dataInicio),a.tarefaData.dataFim=new Date(a.tarefaData.dataFim))}},function(a,b,c,d){})):(a.tarefaData={},a.titulo="Criar tarefa",a.tarefaData.dataInicio=new Date,a.tarefaData.projecto="Escolher projecto"),a.tarefaData.status||(a.tarefaData.status="Aberta"),a.dropSelected=function(b){a.tarefaData.projecto=b},a.estadoSelected=function(b){a.tarefaData.status=b},a.gravar=function(){b.tarefa?e.updateTarefaForEmployee(b.id,a.tarefaData,function(){}):e.createTarefaForEmployee(b.id,a.tarefaData,function(){d.path("/recursos/"+b.id)},function(){})}}]),mainApp.controller("usersController",["$scope","$modal","UserServices",function(a,b,c){c.getAllUsers(function(b){a.users=b},function(a,b,c,d){}),a.deleteSelected=function(){var b=a.users.indexOf(a.selected);b>-1&&a.users.splice(b,1)},a.confirmDeletion=function(b){a.selected=b,c.deleteUser(a.selected._id,a.deleteSelected,function(a,b){})},a.requestDeleteSelected=function(c){a.selected=c;var d=b.open({animation:!0,templateUrl:"/modals/popToConfirm.html",controller:"popToConfirmController",size:"sm",resolve:{texto:function(){return"Deseja apagar este utilizador?"}}});d.result.then(function(b){a.confirmDeletion(c)})}}]),mainApp.controller("usersDetailController",["$scope","$routeParams","ngToast","UserServices",function(a,b,c,d){d.getUserForId(b.id,function(b){a.userData=b},function(a){}),a.gravar=function(){a.modificarForm.$valid&&d.updateUser(b.id,a.userData,function(a){c.create("Gravado com sucesso")},function(a){})}}]),mainApp.controller("criarUserController",["$scope","$routeParams","ngToast","UserServices",function(a,b,c,d){a.gravar=function(){a.criarForm.$valid&&(a.userData.password==a.confirmPass?d.createUser(a.userData,function(){c.create("Gravado com sucesso")},function(a){}):c.danger("Passwords não são identicas"))}}]),mainApp.service("BacklogServices",["ProjectoServices","EmployeeServices",function(a,b){var c=function(a,b){for(var c=0;c<a.horas.length;c++){var d=a.horas[c];if(d.recursoId==b._id)return d}return void 0};this.getBacklogColumnDefs=function(b){var c=[];a.getAllProjectos(function(a){for(var d=0;d<a.length;d++)c.push({headerName:a[d].name,field:a[d].codigo,projectId:a[d]._id});b(c)},function(a){})},this.getBacklogData=function(d,e){var f,g=[];a.getAllProjectos(function(a){var d=a;b.getAllEmployees(function(a){for(var b=0;b<a.length;b++){f={nivel:a[b].nivel,recurso:a[b].name,rate:a[b].rateHora,recursoid:a[b]._id};for(var h=0;h<d.length;h++){var i=d[h],j=c(d[h],a[b]);j?f[i.codigo]=j.numero:f[i.codigo]=0}g.push(f)}e(g)},function(a){debug("Error:"),debug(a)})},function(a){debug("Error:"),debug(a)})},this.updateProjecto=function(b,d,e,f){var g=function(){},h=function(){};a.getProjectoForId(b,function(b){var i=c(b,f);i?i.numero=i.numero+d:(i={},i.recursoId=f,i.numero=d,i.periodo=e,b.horas.push(i)),a.updateProjecto(b._id,b,g,h)},function(a){debug("Error:"),debug(a)})}}]),mainApp.service("ProjectoServices",["$http",function(a){this.getAllProjectos=function(b,c){a.get("/projectos/projectos").success(b).error(c)},this.getProjectoForId=function(b,c,d){a.get("/projectos/projectos/"+b).success(c).error(d)},this.createProjecto=function(b,c,d){a.post("/projectos/projectos",b,{}).success(c).error(d)},this.updateProjecto=function(b,c,d,e){debug("Error:"),debug(c),a.put("/projectos/projectos/"+b,c,{}).success(d).error(e)},this.deleteProjecto=function(b,c,d){a["delete"]("/projectos/projectos/"+b,{}).success(c).error(d)}}]),mainApp.service("EmployeeServices",["$http",function(a){this.getAllEmployees=function(b,c){a.get("/recursos/recursos").success(b).error(c)},this.getEmployeeForId=function(b,c,d){a.get("/recursos/recursos/"+b).success(c).error(d)},this.createEmployee=function(b,c,d){a.post("/recursos/recursos/",b,{}).success(c).error(d)},this.updateEmployee=function(b,c,d,e){a.put("/recursos//recursos/"+b,c,{}).success(d).error(e)},this.deleteEmployee=function(b,c,d){a["delete"]("/recursos//recursos/"+b,{}).success(c).error(d)},this.createTarefaForEmployee=function(b,c,d,e){a.post("/recursos/recursos/"+b+"/tarefa",c,{}).success(d).error(e)}}]),mainApp.service("UserServices",["$http",function(a){this.getAllUsers=function(b,c){a.get("/users/utilizadores").success(b).error(c)},this.getUserForId=function(b,c,d){a.get("/users/utilizadores/"+b).success(c).error(d)},this.createUser=function(b,c,d){a.post("/users/utilizadores",b,{}).success(c).error(d)},this.updateUser=function(b,c,d,e){a.put("/users/utilizadores/"+b,c,{}).success(d).error(e)},this.deleteUser=function(b,c,d){a["delete"]("/users/utilizadores/"+b,{}).success(c).error(d)}}]),mainApp.controller("popToConfirmController",["$scope","$modalInstance","texto",function(a,b,c){a.mensagem=c,a.ok=function(){b.close("ok")},a.cancel=function(){b.dismiss("cancel")}}]);