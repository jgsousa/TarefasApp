var mainApp=angular.module("mainApp",["ngRoute","ngToast","ui.bootstrap","nvd3","ui.grid","ui.grid.edit","ui.grid.grouping","ui.grid.exporter"]);mainApp.config(["$routeProvider",function(a){a.when("/main",{templateUrl:"pages/main/main.html",controller:"mainController"}).when("/users",{templateUrl:"pages/user/users.html",controller:"usersController"}).when("/users/:id",{templateUrl:"pages/user/usersdetail.html",controller:"usersDetailController"}).when("/criaruser",{templateUrl:"pages/user/criaruser.html",controller:"criarUserController"}).when("/tarefas",{templateUrl:"pages/tarefas/tarefas.html",controller:"tarefasController"}).when("/recursos",{templateUrl:"pages/recursos/recursos.html",controller:"recursosController"}).when("/criarrecursos",{templateUrl:"pages/recursos/criarrecurso.html",controller:"criarRecursosController"}).when("/recursos/:id",{templateUrl:"pages/recursos/recursosdetail.html",controller:"recursosDetailController"}).when("/recursos/:id/tarefa/:tarefa",{templateUrl:"pages/tarefas/tarefasdetail.html",controller:"tarefasDetailController"}).when("/recursos/:id/novatarefa",{templateUrl:"pages/tarefas/tarefasdetail.html",controller:"tarefasDetailController"}).when("/projectos",{templateUrl:"pages/projectos/projectos.html",controller:"projectosController"}).when("/criarprojecto",{templateUrl:"pages/projectos/projectodetail.html",controller:"projectosDetailController"}).when("/projectos/:id",{templateUrl:"pages/projectos/projectodetail.html",controller:"projectosDetailController"}).when("/backlog",{templateUrl:"pages/backlog/backlog.html",controller:"backlogController"}).when("/budget",{templateUrl:"pages/budget/budget.html",controller:"budgetController"}).when("/login",{templateUrl:"pages/users/login.html"}).otherwise({redirectTo:"/main"})}]),mainApp.config(["ngToastProvider",function(a){a.configure({verticalPosition:"top",horizontalPosition:"right",maxNumber:3,timeout:2e3,dismissOnTimeout:!0})}]),mainApp.controller("navController",["$scope",function(a){a.funcao1="Utilizadores",a.funcao2="Backlog",a.funcao3="Recursos",a.funcao4="Projectos",a.funcao5="Budget"}]),mainApp.controller("backlogController",["$scope","BacklogServices","uiGridGroupingConstants","uiGridConstants","BudgetServices",function(a,b,c,d,e){var f=["Partner","AP","Senior Manager","Manager","Senior Consultant","Consultant","Analista"],g=function(a,b){var c=f.indexOf(a.nivel),d=f.indexOf(b.nivel);return c-d};a.meses=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],a.anos=["2015","2016","2017"];var h=new Date,i=h.getMonth(),j=h.getFullYear();a.backlogData={},a.backlogData.mes=a.meses[i],a.backlogData.ano=j,a.gridOptions={showColumnFooter:!0,enableSorting:!1,columnDefs:[{field:"nivel",headerCellClass:"blue",width:150,pinnedLeft:!0,grouping:{groupPriority:0}},{field:"recurso",headerCellClass:"blue",width:150,pinnedLeft:!0,enableFilter:!0},{field:"rate",headerCellClass:"blue",width:70,pinnedLeft:!0},{field:"horas",headerCellClass:"blue",width:70,pinnedLeft:!0,cellClass:function(a,b,c,d,e){var f=a.getCellValue(b,c);return void 0!=f?a.getCellValue(b,c)>100?"green":"red":void 0}}],enableGridMenu:!0,exporterCsvFilename:"myFile.csv",exporterCsvLinkElement:angular.element(document.querySelectorAll(".custom-csv-link-location"))},a.getPeriodo=function(){var b=a.meses.indexOf(a.backlogData.mes)+1;return 10>b&&(b="0"+b),a.backlogData.ano+b},b.getBacklogColumnDefs(function(b){for(var d=0;d<b.length;d++)b[d].displayName=b[d].field,b[d].projectId=b[d].projectId,b[d].width=120,b[d].displayName=b[d].field,b[d].headerCellClass="blue",b[d].enableCellEdit=!0,b[d].treeAggregationType=c.aggregation.sum,b[d].footerCellTemplate='<div class="ui-grid-cell-contents">{{grid.appScope.'+b[d].field+"}} €</div>",a.gridOptions.columnDefs.push(b[d])}),a.gridOptions.onRegisterApi=function(c){a.gridApi=c,a.msg={};var e={};c.edit.on.afterCellEdit(a,function(f,g,h,i){b.updateProjecto(g.projectId,h,a.getPeriodo(),f.recursoid);var j=h-i;f.horas=f.horas+j,e[f.$$hashKey]=e[f.$$hashKey]||[],e[f.$$hashKey].push("horas".split(".")[0]),f.changed=e,c.core.notifyDataChange(d.dataChange.COLUMN),a.$apply(),a.actualizarTotais(),a.budgetData.percentagem=a.getPercentagem()})},a.actualizarTotais=function(){a.gridOptions.columnDefs.forEach(function(b,c){a[b.field]=0,"nivel"!=b.field&&"horas"!=b.field&&"rate"!=b.field&&"recurso"!=b.field&&a.gridOptions.data.forEach(function(c,d){a[b.field]=a[b.field]+c[b.field]*c.rate})})},a.getPercentagem=function(){var b=0;return a.gridOptions.columnDefs.forEach(function(c,d){"nivel"!=c.field&&"horas"!=c.field&&"rate"!=c.field&&"recurso"!=c.field&&a.gridOptions.data.forEach(function(a,d){b+=a[c.field]*a.rate})}),Math.round(b/a.budgetData.valor*100)},b.getBacklogData(a.getPeriodo(),function(b){a.gridOptions.data=b.sort(g),a.actualizarTotais(),a.budgetData.percentagem=a.getPercentagem()}),e.getBudgetForId(a.getPeriodo(),function(b){a.budgetData={},b.valor?(a.budgetData.valor=b.valor,a.budgetData.horas=b.horas):(a.budgetData.valor=0,a.budgetData.horas=0)},function(a){}),a.mesSelected=function(c){a.backlogData.mes=c,b.getBacklogData(a.getPeriodo(),function(b){a.gridOptions.data=b,a.actualizarTotais(),a.budgetData.percentagem=a.getPercentagem()})},a.anoSelected=function(c){a.backlogData.ano=c,b.getBacklogData(a.getPeriodo(),function(b){a.gridOptions.data=b,a.actualizarTotais(),a.budgetData.percentagem=a.getPercentagem()})}}]),mainApp.controller("budgetController",["$scope","BudgetServices",function(a,b){a.meses=["Janeiro","Fevereiro","Marco","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],a.anos=["2015","2016","2017"],a.gridOptions={showColumnFooter:!0,enableSorting:!1,columnDefs:[{field:"periodo",headerCellClass:"blue",width:150,pinnedLeft:!0},{field:"valor",headerCellClass:"blue",width:150,pinnedLeft:!0},{field:"horas",headerCellClass:"blue",width:150,pinnedLeft:!0}]},a.gridOptions.onRegisterApi=function(c){a.gridApi=c,a.msg={},c.edit.on.afterCellEdit(a,function(c,d,e,f){c._id?b.updateBudget(c._id,c,function(){}):b.createBudget(c,function(a){c._id=a._id}),a.$apply()})},b.getAllBudgets(function(b){var c=[{periodo:"201501",valor:0,horas:0},{periodo:"201501",valor:0,horas:0},{periodo:"201502",valor:0,horas:0},{periodo:"201503",valor:0,horas:0},{periodo:"201504",valor:0,horas:0},{periodo:"201505",valor:0,horas:0},{periodo:"201506",valor:0,horas:0},{periodo:"201507",valor:0,horas:0},{periodo:"201508",valor:0,horas:0},{periodo:"201509",valor:0,horas:0},{periodo:"201510",valor:0,horas:0},{periodo:"201511",valor:0,horas:0},{periodo:"201512",valor:0,horas:0},{periodo:"201601",valor:0,horas:0},{periodo:"201602",valor:0,horas:0},{periodo:"201603",valor:0,horas:0},{periodo:"201604",valor:0,horas:0},{periodo:"201605",valor:0,horas:0},{periodo:"201606",valor:0,horas:0},{periodo:"201607",valor:0,horas:0},{periodo:"201608",valor:0,horas:0}];c.forEach(function(a){b.forEach(function(b){a.periodo==b.periodo&&(a.valor=b.valor,a.horas=b.horas,a._id=b._id)})}),a.gridOptions.data=c},function(a){})}]),mainApp.controller("mainController",["$scope","$http",function(a,b){var c=[{key:"Alocado",y:0},{key:"Livre",y:0}];a.pieOptions={chart:{type:"pieChart",height:400,x:function(a){return a.key},y:function(a){return a.y},showLabels:!0,labelThreshold:.01,legend:{margin:{top:5,right:35,bottom:5,left:0},padding:{left:10,right:10}}}},a.barOptions={chart:{type:"discreteBarChart",height:400,margin:{top:20,right:20,bottom:60,left:55},x:function(a){return a.key},y:function(a){return a.y},showValues:!0,transitionDuration:500,xAxis:{axisLabel:"Projecto"},yAxis:{axisLabel:"Nº recursos",axisLabelDistance:30}}};var d=function(b,d,e,f){for(var g=0;g<b.length;g++)"Sim"===b[g].tem.tarefa?c[0].y=c[0].y+1:c[1].y=c[1].y+1;a.data=c};b.get("/recursos/recursos").success(d).error(function(a,b,c,d){});var e=function(a,b){for(var c=0;c<b.length;c++)if(b[c].key==a)return b[c];return void 0};b.get("/recursos/tarefas").success(function(b){for(var c,d=[],f=0;f<b.length;f++)c=e(b[f].projecto,d),c?c.y=c.y+1:(c={},c.key=b[f].projecto,c.y=1,d.push(c));a.data2=[{key:"Cumulative",values:d}]}).error(function(a){})}]),mainApp.controller("projectosController",["$scope","$modal","ProjectoServices",function(a,b,c){c.getAllProjectos(function(b){a.projectos=b},function(a,b,c,d){debug("Error:"),debug(a)})}]),mainApp.controller("projectosDetailController",["$scope","$routeParams","ProjectoServices","$location",function(a,b,c,d){a.estados=["Aberto","Fechado"],b.id?(a.titulo="Detalhe de projecto",c.getProjectoForId(b.id,function(b){a.projData=b,a.projData.dataInicio=new Date(a.projData.dataInicio),a.projData.dataFim=new Date(a.projData.dataFim)},function(a,b,c,d){})):(a.titulo="Criar projecto",a.projData={},a.projData.estado="Aberto"),a.estadoSelected=function(b){a.projData.estado=b},a.gravar=function(){b.id?c.updateProjecto(b.id,a.projData,function(){d.path("/projectos/")}):c.createProjecto(a.projData,function(){d.path("/projectos/")})}}]);var niveis=["Partner","AP","Senior Manager","Manager","Senior Consultant","Consultant","Analista"];mainApp.controller("recursosController",["$scope","$filter","EmployeeServices",function(a,b,c){c.getAllEmployees(function(b){a.empregados=b},function(a){}),a.sortNome=function(){a.empregados=b("orderBy")(a.empregados,"name")},a.sortNivel=function(){a.empregados=b("orderBy")(a.empregados,"nivel")},a.soLivresChanged=function(){a.filtro||(a.filtro={}),a.filtro.tarefa={},a.soLivres?a.filtro.tarefa.actual="!":a.filtro.tarefa.actual=void 0}}]),mainApp.controller("recursosDetailController",["$scope","$routeParams","ngToast","$location","EmployeeServices",function(a,b,c,d,e){a.niveis=niveis,e.getEmployeeForId(b.id,function(b){a.empData=b},function(a){}),a.gravar=function(){a.modificarForm.$valid&&e.updateEmployee(b.id,a.empData,function(a){d.path("/recursos")},function(a){})},a.adicionar=function(){d.path("/recursos/"+b.id+"/novatarefa")},a.navegarTarefa=function(a){d.path("/recursos/"+b.id+"/tarefa/"+a._id)}}]),mainApp.controller("criarRecursosController",["$scope","ngToast","$location","EmployeeServices",function(a,b,c,d){a.empData={},a.empData.nivel="Escolher nível",a.niveis=niveis,a.gravar=function(){a.criarForm.$valid&&"Escolher nível"!=a.empData.nivel?d.createEmployee(a.empData,function(){c.path("/recursos")}):b.create("Escolher nível")},a.dropSelected=function(b){a.empData.nivel=b}}]),mainApp.controller("tarefasDetailController",["$scope","$routeParams","ngToast","$location","EmployeeServices","ProjectoServices",function(a,b,c,d,e,f){var g=["Aberta","Fechada"];f.getAllProjectos(function(b){var c=[];c.push("Non-chargable");for(var d=0;d<b.length;d++)c.push(b[d].codigo);a.projectos=c},function(a){}),a.estados=g,a.tarefaData={},b.tarefa?(a.titulo="Detalhe tarefa",e.getEmployeeForId(b.id,function(c){for(var d=0;d<c.tarefas.length;d++){var e=c.tarefas[d];e._id==b.tarefa&&(a.tarefaData=e,a.tarefaData.dataInicio=new Date(a.tarefaData.dataInicio),a.tarefaData.dataFim=new Date(a.tarefaData.dataFim))}},function(a,b,c,d){})):(a.tarefaData={},a.titulo="Criar tarefa",a.tarefaData.dataInicio=new Date,a.tarefaData.projecto="Escolher projecto"),a.tarefaData.status||(a.tarefaData.status="Aberta"),a.dropSelected=function(b){a.tarefaData.projecto=b},a.estadoSelected=function(b){a.tarefaData.status=b},a.gravar=function(){b.tarefa?e.updateTarefaForEmployee(b.id,a.tarefaData,function(){}):e.createTarefaForEmployee(b.id,a.tarefaData,function(){d.path("/recursos/"+b.id)},function(){})}}]),mainApp.controller("usersController",["$scope","$modal","UserServices","$q",function(a,b,c,d){c.getAllUsers().then(function(b){a.users=b},function(a){});var e=function(b){return c.deleteUser(a.selected._id)},f=function(){var b=a.users.indexOf(a.selected);b>-1&&a.users.splice(b,1)};a.requestDeleteSelected=function(c){a.selected=c;var d=b.open({animation:!0,templateUrl:"/modals/popToConfirm.html",controller:"popToConfirmController",size:"sm",resolve:{texto:function(){return"Deseja apagar este utilizador?"}}});d.result.then(e).then(f)}}]),mainApp.controller("usersDetailController",["$scope","$routeParams","ngToast","UserServices","$location",function(a,b,c,d,e){d.getUserForId(b.id).then(function(b){b?a.userData=b:e.path("/users/")},function(a){}),a.gravar=function(){a.modificarForm.$valid&&d.updateUser(b.id,a.userData).then(function(a){c.create("Gravado com sucesso")},function(a){})}}]),mainApp.controller("criarUserController",["$scope","$routeParams","ngToast","UserServices",function(a,b,c,d){a.gravar=function(){a.criarForm.$valid&&(a.userData.password==a.confirmPass?d.createUser(a.userData).then(function(){c.create("Gravado com sucesso")},function(a){}):c.danger("Passwords não são identicas"))}}]),mainApp.service("BacklogServices",["ProjectoServices","EmployeeServices",function(a,b){var c=function(a,b,c){for(var d=0;d<a.horas.length;d++){var e=a.horas[d];if(e.recursoId==b&&e.periodo==c)return e}return void 0};this.getBacklogColumnDefs=function(b){var c=[];a.getAllProjectos(function(a){for(var d=0;d<a.length;d++)c.push({headerName:a[d].name,field:a[d].codigo,projectId:a[d]._id});b(c)},function(a){})},this.getBacklogData=function(d,e){var f,g=[];a.getAllProjectos(function(a){var h=a;b.getAllEmployees(function(a){for(var b=0;b<a.length;b++){f={nivel:a[b].nivel,recurso:a[b].name,rate:a[b].rateHora,recursoid:a[b]._id,horas:0};for(var i=0;i<h.length;i++){var j=h[i],k=c(h[i],a[b]._id,d);k?(f[j.codigo]=k.numero,f.horas=f.horas+k.numero):f[j.codigo]=0}g.push(f)}e(g)},function(a){debug("Error:"),debug(a)})},function(a){debug("Error:"),debug(a)})},this.updateProjecto=function(b,d,e,f){var g=function(){},h=function(){};a.getProjectoForId(b,function(b){var i=c(b,f,e);i?i.numero=d:(i={},i.recursoId=f,i.numero=d,i.periodo=e,b.horas.push(i)),a.updateProjecto(b._id,b,g,h)},function(a){debug("Error:"),debug(a)})}}]),mainApp.service("BudgetServices",["$http",function(a){this.getAllBudgets=function(b,c){a.get("/budget/").success(b).error(c)},this.getBudgetForId=function(b,c,d){a.get("/budget/"+b).success(c).error(d)},this.createBudget=function(b,c,d){a.post("/budget/create/",b,{}).success(c).error(d)},this.updateBudget=function(b,c,d,e){a.put("/budget/"+b,c,{}).success(d).error(e)},this.deleteBudget=function(b,c,d){a["delete"]("/budget/"+b,{}).success(c).error(d)}}]),mainApp.service("ProjectoServices",["$http",function(a){this.getAllProjectos=function(b,c){a.get("/projectos/projectos").success(b).error(c)},this.getProjectoForId=function(b,c,d){a.get("/projectos/projectos/"+b).success(c).error(d)},this.createProjecto=function(b,c,d){a.post("/projectos/projectos",b,{}).success(c).error(d)},this.updateProjecto=function(b,c,d,e){a.put("/projectos/projectos/"+b,c,{}).success(d).error(e)},this.deleteProjecto=function(b,c,d){a["delete"]("/projectos/projectos/"+b,{}).success(c).error(d)}}]),mainApp.service("EmployeeServices",["$http",function(a){this.getAllEmployees=function(b,c){a.get("/recursos/recursos").success(b).error(c)},this.getEmployeeForId=function(b,c,d){a.get("/recursos/recursos/"+b).success(c).error(d)},this.createEmployee=function(b,c,d){a.post("/recursos/recursos/",b,{}).success(c).error(d)},this.updateEmployee=function(b,c,d,e){a.put("/recursos//recursos/"+b,c,{}).success(d).error(e)},this.deleteEmployee=function(b,c,d){a["delete"]("/recursos//recursos/"+b,{}).success(c).error(d)},this.createTarefaForEmployee=function(b,c,d,e){a.post("/recursos/recursos/"+b+"/tarefa",c,{}).success(d).error(e)}}]),mainApp.service("UserServices",["$http","$q",function(a,b){this.getAllUsers=function(){return a.get("/users/utilizadores").then(function(a){return a.data})},this.getUserForId=function(c){return a.get("/users/utilizadores/"+c).then(function(a){return a.data},function(a){b.reject(a.data)})},this.createUser=function(b){return a.post("/users/utilizadores",b,{}).then(function(a){return a.data})},this.updateUser=function(b,c){return a.put("/users/utilizadores/"+b,c,{}).then(function(a){return a.data})},this.deleteUser=function(b){return a["delete"]("/users/utilizadores/"+b,{}).then(function(a){return b})}}]),mainApp.controller("popToConfirmController",["$scope","$modalInstance","texto",function(a,b,c){a.mensagem=c,a.ok=function(){b.close("ok")},a.cancel=function(){b.dismiss("cancel")}}]);